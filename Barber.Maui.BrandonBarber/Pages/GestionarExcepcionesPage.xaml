<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Barber.Maui.BrandonBarber.Pages.GestionarExcepcionesPage"
             BackgroundColor="#0E2A36"
             xmlns:controls="clr-namespace:Barber.Maui.BrandonBarber.Controls">
	<Grid>

		<Grid RowDefinitions="Auto,*">

			<Label Text="Gestionar Días No Disponibles"
					   FontSize="22"
					   FontAttributes="Bold"
					   TextColor="White"
					   HorizontalOptions="Center"/>

			<!-- Content -->
			<ScrollView Grid.Row="1" VerticalScrollBarVisibility="Never">
				<VerticalStackLayout Padding="20" Spacing="20">

					<!-- Información -->
					<Border BackgroundColor="#28475C"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0">
						<VerticalStackLayout Spacing="8">
							<Label Text="Información"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="White"/>
							<Label Text="Marca días donde no estarás disponible o tendrás horarios diferentes. Los clientes con citas serán notificados automáticamente."
								   FontSize="14"
								   TextColor="#E0F7FA"
								   LineBreakMode="WordWrap"/>
						</VerticalStackLayout>
					</Border>

					<!-- Selector de Fecha -->
					<Border BackgroundColor="#90A4AE"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0">
						<VerticalStackLayout Spacing="10">
							<Label Text="Selecciona el día"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="Black"/>
							<DatePicker x:Name="FechaPicker"
										MinimumDate="{x:Static x:DateTime.Today}"
										TextColor="Black"
										FontSize="16"
										DateSelected="OnFechaSelected"/>
						</VerticalStackLayout>
					</Border>

					<!-- Tipo de Excepción -->
					<Border BackgroundColor="#90A4AE"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0">
						<VerticalStackLayout Spacing="10">
							<Label Text="Tipo de cambio"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="Black"/>

							<RadioButton x:Name="DiaCompletoRadio"
										 Content="No estaré disponible todo el día"
										 TextColor="Black"
										 GroupName="TipoExcepcion"
										 IsChecked="True"
										 CheckedChanged="OnTipoExcepcionChanged"/>

							<RadioButton x:Name="HorarioModificadoRadio"
										 Content="Tendré horarios diferentes"
										 TextColor="Black"
										 GroupName="TipoExcepcion"
										 CheckedChanged="OnTipoExcepcionChanged"/>
						</VerticalStackLayout>
					</Border>

					<!-- Horarios Modificados (solo si se selecciona esa opción) -->
					<Border x:Name="HorariosModificadosContainer"
							BackgroundColor="#90A4AE"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0"
							IsVisible="False">
						<VerticalStackLayout Spacing="10">
							<Label Text="Nuevos horarios disponibles"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="Black"/>

							<Grid ColumnDefinitions="*,*" ColumnSpacing="10">
								<VerticalStackLayout Grid.Column="0">
									<Label Text="Hora inicio" TextColor="Black" FontSize="14"/>
									<TimePicker x:Name="HoraInicioPicker"
												TextColor="Black"
												Format="hh:mm tt"/>
								</VerticalStackLayout>

								<VerticalStackLayout Grid.Column="1">
									<Label Text="Hora fin" TextColor="Black" FontSize="14"/>
									<TimePicker x:Name="HoraFinPicker"
												TextColor="Black"
												Format="hh:mm tt"/>
								</VerticalStackLayout>
							</Grid>
						</VerticalStackLayout>
					</Border>

					<!-- Motivo -->
					<Border BackgroundColor="#90A4AE"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0">
						<VerticalStackLayout Spacing="10">
							<Label Text="Motivo (opcional)"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="Black"/>
							<Editor x:Name="MotivoEditor"
									Placeholder="Ej: Asunto personal, Capacitación, etc."
									PlaceholderColor="#666"
									TextColor="Black"
									HeightRequest="100"
									MaxLength="500"/>
						</VerticalStackLayout>
					</Border>

					<!-- Vista previa de citas afectadas -->
					<Border x:Name="CitasAfectadasContainer"
							BackgroundColor="#FFF3E0"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0"
							IsVisible="False">
						<VerticalStackLayout Spacing="10">
							<Label x:Name="CitasAfectadasLabel"
								   Text="Citas afectadas: 0"
								   FontSize="16"
								   FontAttributes="Bold"
								   TextColor="#E65100"/>
							<Label x:Name="CitasDetalleLabel"
								   Text="Se notificará a los clientes automáticamente"
								   FontSize="14"
								   TextColor="#BF360C"/>
						</VerticalStackLayout>
					</Border>

					<!-- Botones -->
					<Button Text="Guardar Excepción"
							BackgroundColor="#FF6F91"
							TextColor="Black"
							FontAttributes="Bold"
							CornerRadius="15"
							HeightRequest="50"
							Clicked="OnGuardarClicked"/>

					<!-- Lista de excepciones existentes -->
					<Border BackgroundColor="#28475C"
							StrokeShape="RoundRectangle 15"
							Padding="15"
							StrokeThickness="0">
						<VerticalStackLayout Spacing="10">
							<Label Text="Excepciones programadas"
								   FontSize="18"
								   FontAttributes="Bold"
								   TextColor="White"/>

							<CollectionView x:Name="ExcepcionesCollectionView">
								<CollectionView.ItemTemplate>
									<DataTemplate>
										<Border BackgroundColor="#90A4AE"
												StrokeShape="RoundRectangle 10"
												Padding="15"
												Margin="0,5"
												StrokeThickness="0">
											<Grid ColumnDefinitions="*,Auto">
												<VerticalStackLayout Grid.Column="0" Spacing="5">
													<Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy}'}"
														   FontSize="16"
														   FontAttributes="Bold"
														   TextColor="Black"/>
													<Label Text="{Binding TipoExcepcion}"
														   FontSize="14"
														   TextColor="#333"/>
													<Label Text="{Binding Motivo}"
       FontSize="12"
       TextColor="#666"
       IsVisible="{Binding Motivo, Converter={StaticResource StringNotEmptyConverter}}"/>
												</VerticalStackLayout>

												<Button Grid.Column="1"
														ImageSource="delete.png"
														BackgroundColor="Transparent"
														TextColor="White"
														WidthRequest="60"
														Clicked="OnEliminarExcepcionClicked"
														CommandParameter="{Binding .}"/>
											</Grid>
										</Border>
									</DataTemplate>
								</CollectionView.ItemTemplate>
							</CollectionView>
						</VerticalStackLayout>
					</Border>

				</VerticalStackLayout>
			</ScrollView>

		</Grid>
		<controls:LoadingControl x:Name="LoadingIndicator" IsVisible="False"/>
	</Grid>
</ContentPage>