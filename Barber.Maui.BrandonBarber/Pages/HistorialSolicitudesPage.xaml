<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
 x:Class="Barber.Maui.BrandonBarber.Pages.HistorialSolicitudesPage" xmlns:local="clr-namespace:Barber.Maui.BrandonBarber.style"
 BackgroundColor="#0E2A36">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:EstadoColorConverter x:Key="EstadoColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Encabezado con título y contador -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="20,20,20,10">
            <Label Grid.Column="0" Text="Historial de Solicitudes" FontSize="20" TextColor="White" FontAttributes="Bold" VerticalOptions="Center" HorizontalOptions="Start" />
            <VerticalStackLayout Grid.Column="1" HorizontalOptions="End" VerticalOptions="Center">
                <Label x:Name="TotalSolicitudesLabel" Text="0" FontSize="24" TextColor="White" FontAttributes="Bold" HorizontalOptions="Center" />
                <Label Text="Solicitudes" FontSize="12" TextColor="White" HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Barra de búsqueda -->
        <Border Grid.Row="1" BackgroundColor="#28475C" StrokeShape="25" Margin="20,0,20,10" StrokeThickness="0" HeightRequest="50">
            <Grid ColumnDefinitions="*, Auto">
                <Entry Grid.Column="0" Placeholder="Buscar por nombre, email o teléfono..." Margin="10,0,0,0" VerticalOptions="Center" PlaceholderColor="#A0A0A0" TextColor="White" TextChanged="OnSearchTextChanged" BackgroundColor="Transparent" x:Name="SearchBar" FontSize="16"/>
                <Image Grid.Column="1" Source="search.png" WidthRequest="24" HeightRequest="24" Margin="0,0,15,0" VerticalOptions="Center" Opacity="0.6"/>
            </Grid>
        </Border>

        <!-- CollectionView y EmptyState -->
        <Grid Grid.Row="2">
            <CollectionView VerticalScrollBarVisibility="Never" HorizontalScrollBarVisibility="Never" x:Name="SolicitudesCollection" ItemsSource="{Binding SolicitudesFiltradas}" Margin="20,0,20,20">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border BackgroundColor="#90A4AE" StrokeShape="10" Padding="10" StrokeThickness="0" Margin="0,0,0,10">
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto">
                                <VerticalStackLayout Grid.Column="0" Spacing="5">
                                    <HorizontalStackLayout Spacing="5">
                                        <Image Source="id.png" WidthRequest="20" HeightRequest="20" />
                                        <Label Text="{Binding NombreSolicitante}" FontAttributes="Bold" FontSize="18"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout Spacing="10">
                                        <Image Source="email.png" WidthRequest="20" HeightRequest="20" />
                                        <Label Text="{Binding EmailSolicitante}" FontAttributes="Bold"/>
                                    </HorizontalStackLayout>

                                    <HorizontalStackLayout Spacing="10">
                                        <Image Source="call.png" WidthRequest="20" HeightRequest="20" />
                                        <Label Text="{Binding TelefonoSolicitante}" FontAttributes="Bold"/>
                                    </HorizontalStackLayout>

                                    <HorizontalStackLayout Spacing="10">
                                        <Image Source="calendar.png" WidthRequest="20" HeightRequest="20" />
                                        <Label Text="{Binding FechaSolicitud, StringFormat='{0:dd/MM/yyyy}'}" FontAttributes="Bold"/>
                                    </HorizontalStackLayout>

                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" IsVisible="{Binding EsRechazada}">
                                        <Image Grid.Column="0" Source="rechazar.png" WidthRequest="20" HeightRequest="20" />
                                        <Label Grid.Column="1" Text="{Binding MotivoRechazo}" FontAttributes="Bold" LineBreakMode="WordWrap"/>
                                    </Grid>

                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                        <Image Grid.Column="0" Source="justificacion.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Start"/>
                                        <Label Grid.Column="1" Text="{Binding Justificacion}" FontAttributes="Bold" LineBreakMode="WordWrap"/>
                                    </Grid>

                                </VerticalStackLayout>
                                <Border Grid.Column="1" Stroke="Transparent" WidthRequest="22" HeightRequest="22" StrokeShape="20" VerticalOptions="Center">
                                    <Border.BackgroundColor>
                                        <Binding Path="Estado" Converter="{StaticResource EstadoColorConverter}" />
                                    </Border.BackgroundColor>
                                    <Label Text="{Binding IconoEstado}" TextColor="White" FontSize="10" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <VerticalStackLayout x:Name="EmptyStateLayout" IsVisible="False" VerticalOptions="Center" HorizontalOptions="Center" Spacing="15">
                <Image Source="chat.png" WidthRequest="80" HeightRequest="80" Opacity="0.6"/>
                <Label Text="No hay historial de solicitudes" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>